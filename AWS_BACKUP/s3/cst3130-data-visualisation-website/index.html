<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Crypto Predict And Visualise</title>
<!--    Plotly.js for graph plotting.-->
    <script src="https://cdn.plot.ly/plotly-2.8.3.min.js"></script>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<!--   W3Schools CSS-->
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata">

</head>
<body>
<!-- Menu Container -->
<div class="w3-container" id="menu">
    <div class="w3-content" style="max-width:100%">

        <h5 class="w3-center w3-padding-48"><span class="w3-tag w3-wide">Crypto List</span></h5>

        <div class="w3-row w3-center w3-card w3-padding">
            <a href="javascript:void(0)" onclick="openMenu(event, 'Atom');" id="myLink">
                <div class="w3-col tablink">ATOM</div>
            </a>
            <a href="javascript:void(0)" onclick="openMenu(event, 'Dot');">
                <div class="w3-col tablink">DOT</div>
            </a>
            <a href="javascript:void(0)" onclick="openMenu(event, 'Link');">
                <div class="w3-col tablink">LINK</div>
            </a>
            <a href="javascript:void(0)" onclick="openMenu(event, 'Luna');">
                <div class="w3-col tablink">LUNA</div>
            </a>
            <a href="javascript:void(0)" onclick="openMenu(event, 'Sol');">
                <div class="w3-col tablink">SOL</div>
            </a>
        </div>

        <div id="Atom" class="w3-container menu w3-padding-48 w3-card">
            <div class="container" id="atomGraphDiv" ></div>
        </div>

        <div id="Dot" class="w3-container menu w3-padding-48 w3-card">
            <div class="container" id="dotGraphDiv" ></div>
        </div>

        <div id="Link" class="w3-container menu w3-padding-48 w3-card">
            <div class="container" id="linkGraphDiv" ></div>
        </div>

        <div id="Luna" class="w3-container menu w3-padding-48 w3-card">
            <div class="container" id="lunaGraphDiv" ></div>
        </div>

        <div id="Sol" class="w3-container menu w3-padding-48 w3-card">
            <div class="container" id="solGraphDiv" ></div>
        </div>
    </div>
</div>
<div class="pos-f-t">
    <div id="navbarToggleExternalContent">
        <div class="bg-dark p-4">
            <h5 class="text-white h4">Data Visualisation Website</h5>
            <span class="text-muted">Utilised: Amazon Web Services, SageMaker (DeepAR), Lambda, S3 static web hosting, DynamoDB, CloudWatch, API Gateway, Comprehend</span>
        </div>
    </div>
    <nav class="navbar navbar-dark bg-dark">
<!--        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggleExternalContent" aria-controls="navbarToggleExternalContent" aria-expanded="false" aria-label="Toggle navigation">-->
<!--            <span class="navbar-toggler-icon"></span>-->
<!--        </button>-->
    </nav>
</div>
<p style="border-style: solid; width: 500px; border-width: 1px; max-height: 300px; overflow-y: auto" id="messages"></p>
<!--Numerical-->
<h1>Crypto Currency Prices and Predictions</h1>
<div class="container" id="numericalGraphDiv" ></div>
<!--Sentiment Analysis-->
<h1>Sentiment Analysis</h1>
<div class="container" style="border: 10px solid black;">
    <div class="row">
        <div class="col" id="pieDiv1">
            <b>SOL</b>
        </div>
        <div class="col" id="pieDiv2">
            <b>LINK</b>
        </div>
    </div>
    <div class="row">
        <div class="col" id="pieDiv3">
            <b>LUNA</b>
        </div>
        <div class="col" id="pieDiv4">
            <b>ATOM</b>
        </div>
        <div class="col" id="pieDiv5">
            <b>DOT</b>
        </div>
    </div>
</div>
<!--Synthetic Data-->
<h1>Synthetic Data</h1>
<iframe id="igraph" scrolling="no" style="border: 10px solid black;" seamless="seamless" src="https://chart-studio.plotly.com/~omerka1/0.embed" height="525" width="100%"></iframe>
<script>


    // Tabbed Menu
    function openMenu(evt, menuName) {
        var i, x, tablinks;
        x = document.getElementsByClassName("menu");
        for (i = 0; i < x.length; i++) { //make all of them no display
            x[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablink");
        for (i = 0; i < x.length; i++) { //take off active color
            tablinks[i].className = tablinks[i].className.replace(" w3-dark-grey", "");
        }
        document.getElementById(menuName).style.display = "block";
        evt.currentTarget.firstElementChild.className += " w3-dark-grey";
    }
    document.getElementById("myLink").click();


    //Open connection
    let connection = new WebSocket("wss://7dxr2k9a9b.execute-api.us-east-1.amazonaws.com/prod");

    //Enables graph refresh
    let dataRevision = 0;

    //Log connected response
    connection.onopen = function(event){
        console.log("Connected: " + JSON.stringify(event));
        updatePieChart();
        updateNumericalGraph();
    };

    //Output messages from the server
    connection.onmessage = function(msg){
        let message = msg.data;
        let messageLowerCase = message.toLowerCase();
        if(messageLowerCase.includes("pie")) {
            let plotlyData = JSON.parse(message);

            for(let graphNum=0; graphNum < 5; ++graphNum){
                let dataPie = [{
                    values: plotlyData.data[graphNum].values,
                    labels: plotlyData.data[0].labels,
                    type: plotlyData.data[0].type
                }];

                let layout = {
                    height: 350,
                    width: 300,
                    datarevision: dataRevision
                };
                Plotly.react('pieDiv' + (graphNum + 1), dataPie, layout);
                ++dataRevision;
                console.log("Plotting data for graph " + graphNum);
            }
        } else if (messageLowerCase.includes("updatenumerical")) {
            let plotlyData = JSON.parse(message);
            let lines = plotlyData.data;

            let yValuesATOM = [];
            let yValuesDOT = [];
            let yValuesLINK = [];
            let yValuesLUNA = [];
            let yValuesSOL = [];
            for(let lineIndex = 0; lineIndex < lines.length; lineIndex++) {
                let line = lines[lineIndex];

                if(line.name == 'ATOM') {
                    yValuesATOM = line.y;
                }
                else if(line.name == 'DOT') {
                    yValuesDOT = line.y;
                }
                else if(line.name == 'LINK') {
                    let yValuesLINK = line.y;
                }
                else if(line.name == 'LUNA') {
                    let yValuesLUNA = line.y;
                }
                else if(line.name == 'SOL') {
                    let yValuesSOL = line.y;
                }
            }
            let xValues = lines[0].x;
            Plotly.extendTraces('numericalGraphDiv', {
                x: [xValues,  xValues, xValues, xValues, xValues],
                y: [yValuesATOM, yValuesDOT, yValuesLINK, yValuesLUNA, yValuesSOL]
            }, [0, 1, 2, 3, 4]);
            console.log("LINEOINS: " + JSON.stringify(lines));

        } else if (messageLowerCase.includes("numerical")) {
            let plotlyData = JSON.parse(message);
            let lines = plotlyData.data;
            let layout = {
                xaxis: {
                    autorange: true,
                }
            };
            Plotly.react('numericalGraphDiv', lines, layout);

            let currencies = ["atom", "dot", "link", "luna", "sol"];
            console.log(lines)
            for(let graphNumber = 0; graphNumber < 5; graphNumber++) { //for now no predictions
                let currency = currencies[graphNumber];
                let divIdName = currency + "GraphDiv";
                let lineToPlot = lines[graphNumber];
                Plotly.react(divIdName, lineToPlot);
            }
        } else if(messageLowerCase.includes("tweet")) { //request update on pie charts
            updatePieChart();
            document.getElementById("messages").innerHTML += ("Server message: " + message + "<br>" + "Refreshing the pie charts..." + "<br>");
            console.log("Message received.");
        } else if(messageLowerCase.includes("currency")) { //request update on numerical graph
            updateNumericalGraph();
            document.getElementById("messages").innerHTML += ("Server message: " + message + "<br />");
            console.log("Message received.");
        } else {
            console.log("At least something was received.");
        }
    }

    //Log errors
    connection.onerror = function (error) {
        console.log("WebSocket Error: " + JSON.stringify(error));
    }

    function clearNotifications() {
        document.getElementById("messages").innerHTML = "";
    }

    //Send message to server
    function sendMessage(){
        //Get text from form
        let msgText = document.forms[0].inputString.value;

        //Create message to be sent to server
        let msgObject = {
            sendData: "sendMessage",//Used for routing in API Gateway
            data: msgText
        };

        //Send message
        connection.send(JSON.stringify(msgObject));

        //Log result
        console.log("Message sent: " + JSON.stringify(msgObject));
    }

    //Send request message to update pie char to server
    function updatePieChart(){
        //Create message to be sent to server
        let msgObject = {
            sendData: "updatePie",//Used for routing in API Gateway
            data: ""
        };

        //Send message
        connection.send(JSON.stringify(msgObject));

        //Log result
        console.log("Message sent: " + JSON.stringify(msgObject));

        clearNotifications();
    }

    //Send request message to update graph to server
    function updateNumericalGraph(){
        //Create message to be sent to server
        let msgObject = {
            sendData: "updateNumericalGraph",//Used for routing in API Gateway
            data: ""
        };

        //Send message
        connection.send(JSON.stringify(msgObject));

        //Log result
        console.log("Message sent: " + JSON.stringify(msgObject));
        clearNotifications();
    }

</script>
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</body>
</html>